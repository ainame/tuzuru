name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  XCODE_VERSION: "26.1"

jobs:
  lint:
    runs-on: ubuntu-slim

    steps:
    - uses: actions/checkout@v6
    - uses: ainame/swiftlint-linux@0.62.2
      with:
        strict: true

  test-macos:
    runs-on: macos-26

    steps:
    - uses: actions/checkout@v6

    - name: Set up Xcode
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

    - name: Set Swift version from .swift-version
      run: echo "SWIFT_VERSION=$(cat .swift-version | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Install Swiftly
      run: |
        curl -O https://download.swift.org/swiftly/darwin/swiftly.pkg
        installer -pkg swiftly.pkg -target CurrentUserHomeDirectory
        rm swiftly.pkg
        echo "$HOME/.swiftly/bin" >> "$GITHUB_PATH"

    - name: Install Swift toolchain
      run: |
        export PATH="$HOME/.swiftly/bin:$PATH"
        swiftly init --assume-yes
        swiftly install ${{ env.SWIFT_VERSION }}
        swiftly use ${{ env.SWIFT_VERSION }}

    - name: Restore Swift build cache
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-

    - name: Run tests
      run: swiftly run swift test

  test-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set Swift version from .swift-version
      run: echo "SWIFT_VERSION=$(cat .swift-version | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Restore Swift build cache
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-

    - name: Install Swift toolchain
      uses: vapor/swiftly-action@v0.2
      with:
        toolchain: ${{ env.SWIFT_VERSION }}

    - name: Run tests
      run: swift test

  test-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set Swift version from .swift-version
      shell: bash
      run: |
        # As of 2025/11/01 we need to use 6.2-snapshot for macOS but
        # Windows doesn't need to use it so removing it here as temporary solution
        echo "SWIFT_VERSION=$(cat .swift-version | tr -d '[:space:]' | sed 's/-snapshot$//')" >> $GITHUB_ENV

    - name: Restore Swift build cache
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-

    - name: Install Swift toolchain
      uses: compnerd/gha-setup-swift@main
      with:
        swift-version: swift-${{ env.SWIFT_VERSION }}-release
        swift-build: ${{ env.SWIFT_VERSION }}-RELEASE

    - name: Clean up cached symlinks (Windows workaround)
      shell: pwsh
      run: |
        if (Test-Path .build\debug) {
          Remove-Item -Path .build\debug -Force -ErrorAction SilentlyContinue
        }

    - name: Run tests
      shell: pwsh
      run: swift test

  test:
    needs:
      - test-linux
      - test-macos
      - test-windows
    runs-on: ubuntu-latest
    if: ${{ always() }}

    steps:
    - name: Summarize platform results
      shell: bash
      run: |
        declare -A results
        results[linux]="${{ needs.test-linux.result }}"
        results[macos]="${{ needs.test-macos.result }}"
        results[windows]="${{ needs.test-windows.result }}"

        failed=0
        for platform in "${!results[@]}"; do
          result="${results[$platform]}"
          echo "${platform}: ${result}"
          if [[ "${result}" != "success" ]]; then
            failed=1
          fi
        done

        if [[ ${failed} -ne 0 ]]; then
          echo "One or more platform test jobs did not succeed." >&2
          exit 1
        fi

        echo "All platform test jobs succeeded."
