name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-slim

    steps:
    - uses: actions/checkout@v5
    - uses: ainame/swiftlint-linux@0.62.2
      with:
        strict: true

  test-macos:
    runs-on: macos-26

    steps:
    - uses: actions/checkout@v5

    - name: Set Swift version from .swift-version
      run: echo "SWIFT_VERSION=$(cat .swift-version | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Restore Swift build cache
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-

    - name: Install Swift toolchain
      shell: bash
      run: |
        curl -L -o swift-toolchain.pkg https://download.swift.org/swift-${{ env.SWIFT_VERSION }}-release/xcode/swift-${{ env.SWIFT_VERSION }}-RELEASE/swift-${{ env.SWIFT_VERSION }}-RELEASE-osx.pkg
        sudo installer -pkg swift-toolchain.pkg -target /
        rm swift-toolchain.pkg

    - name: Select Swift toolchain
      shell: bash
      run: |
        echo "/Library/Developer/Toolchains/swift-${{ env.SWIFT_VERSION }}-RELEASE.xctoolchain/usr/bin" >> "$GITHUB_PATH"
        echo "TOOLCHAINS=swift" >> "$GITHUB_ENV"

    - name: Run tests
      shell: bash
      run: swift test

  test-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Set Swift version from .swift-version
      run: echo "SWIFT_VERSION=$(cat .swift-version | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Restore Swift build cache
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-

    - name: Install Swift toolchain
      uses: vapor/swiftly-action@v0.2
      with:
        toolchain: ${{ env.SWIFT_VERSION }}

    - name: Select Swift toolchain
      run: swiftly use $(cat .swift-version)

    - name: Run tests
      run: swift test

  test-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v5

    - name: Set Swift version from .swift-version
      shell: bash
      run: echo "SWIFT_VERSION=$(cat .swift-version | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Restore Swift build cache
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-

    - name: Install Swift toolchain
      uses: compnerd/gha-setup-swift@main
      with:
        swift-version: swift-${{ env.SWIFT_VERSION }}-release
        swift-build: ${{ env.SWIFT_VERSION }}-RELEASE

    - name: Run tests
      shell: pwsh
      run: swift test

  test:
    needs:
      - test-linux
      - test-macos
      - test-windows
    runs-on: ubuntu-latest
    if: ${{ always() }}

    steps:
    - name: Summarize platform results
      shell: bash
      run: |
        declare -A results
        results[linux]="${{ needs.test-linux.result }}"
        results[macos]="${{ needs.test-macos.result }}"
        results[windows]="${{ needs.test-windows.result }}"

        failed=0
        for platform in "${!results[@]}"; do
          result="${results[$platform]}"
          echo "${platform}: ${result}"
          if [[ "${result}" != "success" ]]; then
            failed=1
          fi
        done

        if [[ ${failed} -ne 0 ]]; then
          echo "One or more platform test jobs did not succeed." >&2
          exit 1
        fi

        echo "All platform test jobs succeeded."
